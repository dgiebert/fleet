defaultNamespace: cattle-monitoring-system
# Custom helm options
helm:
  releaseName: rancher-monitoring
  chart: rancher-monitoring
  repo: https://charts.rancher.io
  version: 102.0.0+up40.1.2
  values:
    # Make the UI work 
    global:
      cattle:
        clusterId: '${ index .ClusterLabels "management.cattle.io/cluster-name" }'
    # Add Loki Integration
    grafana:
      additionalDataSources:
      - name: Loki
        type: loki
        access: proxy
        url: http://loki-gateway.loki.svc.cluster.local:80
    prometheus:
      prometheusSpec:
        evaluationInterval: 1m
        scrapeInterval: 1m
        retentionSize: 50GiB
      additionalServiceMonitors:
        - name: kubewarden
          selector:
            matchLabels:
              app: kubewarden-policy-server-default
          namespaceSelector:
            matchNames:
              - kubewarden
          endpoints:
            - port: metrics
              interval: 10s
    # RKE2
    rke2Proxy:
      enabled: true
    rke2ControllerManager:
      enabled: true
    rke2IngressNginx:
      enabled: true
    rke2Scheduler:
      enabled: true
    rke2Etcd:
      enabled: true
dependsOn:
  - name: dgiebert-fleet-rancher-monitoring-crd

# Patches needed for Fleet
diff:
  comparePatches:
  - apiVersion: admissionregistration.k8s.io/v1
    kind: MutatingWebhookConfiguration
    name: rancher-monitoring-admission
    operations:
    - {"op": "remove", "path":"/webhooks/0"}
  - apiVersion: admissionregistration.k8s.io/v1
    kind: ValidatingWebhookConfiguration
    name: rancher-monitoring-admission
    operations:
    - {"op": "remove", "path":"/webhooks/0"}