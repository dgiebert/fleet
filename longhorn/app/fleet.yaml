
defaultNamespace: longhorn-system

# Custom helm options
helm:
  releaseName: longhorn
  chart: https://raw.githubusercontent.com/dgiebert/fleet/develop/longhorn/longhorn-1.4.0.tgz
  #repo: https://charts.rancher.io
  #version: 100.2.2+up1.3.2
  values:
    ingress:
      enabled: true
      # Wait for: https://github.com/rancher/fleet/pull/671
      # host: global.fleet.clusterLabels.management.cattle.io.cluster-display-name
    networkPolicies:
      enabled: true
      type: k3s
      # Wait for: https://github.com/rancher/fleet/pull/671
      # type: global.fleet.clusterLabels.provider.cattle.io
# Fix for sslip.io
diff:
  comparePatches:
  - apiVersion: networking.k8s.io/v1
    kind: Ingress
    name: longhorn-ingress
    namespace: longhorn-system
    operations:
    - {"op": "remove", "path": "/spec/rules/0"}
  - apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: engineimages.longhorn.io
    operations:
    - {"op": "remove", "path": "/spec/conversion/webhook/clientConfig/service/namespace"}
    - {"op": "remove", "path": "/status/acceptedNames/kind"}
    - {"op": "remove", "path": "/status/acceptedNames/plural"}
    - {"op": "remove", "path": "/status/conditions"}
    - {"op": "remove", "path": "/status/storedVersions"}
  - apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: nodes.longhorn.io
    operations:
    - {"op": "remove", "path": "/spec/conversion/webhook/clientConfig/service/namespace"}
    - {"op": "remove", "path": "/status/acceptedNames/kind"}
    - {"op": "remove", "path": "/status/acceptedNames/plural"}
    - {"op": "remove", "path": "/status/conditions"}
    - {"op": "remove", "path": "/status/storedVersions"}
  - apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: volumes.longhorn.io
    operations:
    - {"op": "remove", "path": "/status/acceptedNames/kind"}
    - {"op": "remove", "path": "/status/acceptedNames/plural"}
    - {"op": "remove", "path": "/status/conditions"}
    - {"op": "remove", "path": "/status/storedVersions"}
  - apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: backingimages.longhorn.io
    operations:
    - {"op": "remove", "path": "/spec/conversion/webhook/clientConfig/service/namespace"}
    - {"op": "remove", "path": "/status/acceptedNames/kind"}
    - {"op": "remove", "path": "/status/acceptedNames/plural"}
    - {"op": "remove", "path": "/status/conditions"}
    - {"op": "remove", "path": "/status/storedVersions"}

targetCustomizations:
- name: init
  helm:
    values:
      csi:
        attacherReplicaCount: 1
        provisionerReplicaCount: 1
        resizerReplicaCount: 1
        snapshotterReplicaCount: 1
  clusterSelector:
    matchLabels:
      environment: staging

